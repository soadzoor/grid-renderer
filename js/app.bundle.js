(()=>{var v=class{static getScrollX(){return window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0}static getScrollY(){return window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0}static clientXYToLocalXY(t,e,i){let s=i.getBoundingClientRect(),n=s.left+v.getScrollX(),r=s.top+v.getScrollY();return[t-n,e-r]}};var f=class{};f.MAIN_MOUSE_BUTTON=0,f.SECONDARY_MOUSE_BUTTON=2;var w=class{static emptyFunction(){}};var l=class{static randomFromInterval(t,e){return Math.random()*(e-t)+t}static clamp(t,e,i){return t<e?e:t>i?i:t}static isValidNumber(t){return!(t===null||t===void 0||isNaN(t)||t===Infinity||t===-Infinity)}static sumOfArray(t){let e=0;for(let i of t)e+=i;return e}};var c=class{static compare(t,e){return JSON.stringify(t)===JSON.stringify(e)}static clone(t){return JSON.parse(JSON.stringify(t))}};var _=class{constructor(){this._shouldPropagate=!0;this._bindings=[]}static create(){return new _}add(t,e,i=0){this.registerListener(t,!1,e,i)}addAndCall(t,e,i=0){this.registerListener(t,!1,e,i),e=e||this,t.call(e)}addOnce(t,e,i=0){this.registerListener(t,!0,e,i)}registerListener(t,e,i,s=0){let n=this.indexOfListener(t,i),r=null;if(n!==-1){if(r=this._bindings[n],r.isOnce!==e)throw new Error("You cannot add"+(e?"":"Once")+"() then add"+(e?"Once":"")+"() the same listener without removing the relationship first.")}else r={listener:t,context:i,isOnce:e,priority:s},this.addBinding(r)}addBinding(t){let e=this._bindings.length;do--e;while(this._bindings[e]&&t.priority<=this._bindings[e].priority);this._bindings.splice(e+1,0,t)}indexOfListener(t,e){for(let i=this._bindings.length-1;i>=0;--i){let s=this._bindings[i];if(s.listener===t&&s.context===e)return i}return-1}has(){}halt(){this._shouldPropagate=!1}remove(t,e){let i=this.indexOfListener(t,e);return i!==-1?(this._bindings.splice(i,1),!0):!1}removeAll(){this._bindings.length=0}dispatch(){let t=Array.prototype.slice.call(arguments);this._shouldPropagate=!0;let e=this._bindings;for(let i=e.length-1;i>=0&&!(e[i].listener.apply(e[i].context,t)===!1||!this._shouldPropagate);--i);}dispose(){this.removeAll()}get bindings(){return this._bindings}};var x=class{constructor(t){this._requestAnimationFrameId=0;this._rowSize=30;this._padding=this._rowSize/3;this._visibleDataOnLastFrame=[];this._selectionOnLastFrame=[];this._activeCellOnLastFrame=[];this._offsetOnLastFrame=[];this._frozenColumnCountOnLastFrame=0;this._dragStartCoords=[];this._viewBoxOffsetAtDragStart=[];this._frozenColumnsWidthInPx=0;this._startXInPx=0;this._startYInPx=0;this._startX=0;this._endX=0;this._startY=0;this.viewBoxOffset=[0,0];this.selection=[];this.activeCell=[];this.frozenColumnCount=0;this.data=[];this.columnsWidths=[];this.signals={mouseDown:_.create()};this.onMouseWheel=t=>{let e=Math.sign(t.deltaY),i=this._rowSize*1.5;Math.abs(e)>0&&(this.viewBoxOffset[1]+=e*i);let s=Math.sign(t.deltaX);Math.abs(s)>0&&(this.viewBoxOffset[0]+=s*i)};this.onContextMenu=t=>(t.preventDefault(),!1);this.onMouseDown=t=>{let e=v.clientXYToLocalXY(t.clientX,t.clientY,this._canvas);if(t.button===f.MAIN_MOUSE_BUTTON){let i=this.mousePosToCellPos(e);l.isValidNumber(i[0])&&l.isValidNumber(i[1])&&this.signals.mouseDown.dispatch(i)}else t.button===f.SECONDARY_MOUSE_BUTTON&&(this._dragStartCoords=e,this._viewBoxOffsetAtDragStart=c.clone(this.viewBoxOffset))};this.onMouseMove=t=>{if(this._dragStartCoords.length===2){let e=v.clientXYToLocalXY(t.clientX,t.clientY,this._canvas),i=[e[0]-this._dragStartCoords[0],e[1]-this._dragStartCoords[1]];this.viewBoxOffset[0]=this._viewBoxOffsetAtDragStart[0]-i[0],this.viewBoxOffset[1]=this._viewBoxOffsetAtDragStart[1]-i[1]}};this.onMouseUp=t=>{t.button===f.SECONDARY_MOUSE_BUTTON&&(this._dragStartCoords.length=0)};this.render=()=>{this._requestAnimationFrameId=window.requestAnimationFrame(this.render);let t=l.sumOfArray(this.columnsWidths),e=this._rowSize*this.data.length;this.viewBoxOffset[0]=l.clamp(this.viewBoxOffset[0],0,Math.max(0,t-this._canvas.width)),this.viewBoxOffset[1]=l.clamp(this.viewBoxOffset[1],0,Math.max(0,e-this._canvas.height));let{startX:i,startY:s,endX:n,endY:r}=this.getBBoxOfMovableVisibleCells();this._startX=i,this._endX=n,this._startY=s;let a=this.data.slice(s,r+1).map(o=>o.slice(i,n+1));if(!c.compare(this._activeCellOnLastFrame,this.activeCell)||!c.compare(this._offsetOnLastFrame,this.viewBoxOffset)||!c.compare(this._selectionOnLastFrame,this.selection)||!c.compare(this._frozenColumnCountOnLastFrame,this.frozenColumnCount)||!c.compare(this._visibleDataOnLastFrame,a)){this._visibleDataOnLastFrame=c.clone(a),this._selectionOnLastFrame=c.clone(this.selection),this._activeCellOnLastFrame=c.clone(this.activeCell),this._offsetOnLastFrame=c.clone(this.viewBoxOffset),this._frozenColumnCountOnLastFrame=this.frozenColumnCount;let o=this._ctx;if(o.clearRect(0,0,this._canvas.width,this._canvas.height),this._frozenColumnsWidthInPx=l.sumOfArray(this.columnsWidths.slice(0,this.frozenColumnCount)),this._startXInPx=this._frozenColumnsWidthInPx+l.sumOfArray(this.columnsWidths.slice(this.frozenColumnCount,i))-this.viewBoxOffset[0],this._startYInPx=this._rowSize*s-this.viewBoxOffset[1],this.drawCells(a,this._startXInPx,this._startYInPx,i),this.frozenColumnCount>0){o.beginPath();let d=this.data.slice(s,r+1).map(h=>h.slice(0,this.frozenColumnCount)),m=this._ctx.fillStyle;o.fillStyle="#FFFFFF",o.fillRect(0,0,this._frozenColumnsWidthInPx,this._canvas.height),o.fillStyle=m,this.drawCells(d,0,this._startYInPx,0)}}};this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._ctx.font=`${Math.round(this._rowSize*.6)}px Arial`,this.addEventListeners(),this._requestAnimationFrameId=window.requestAnimationFrame(this.render)}addEventListeners(){this._canvas.addEventListener("mousedown",this.onMouseDown),this._canvas.addEventListener("wheel",this.onMouseWheel),window.addEventListener("contextmenu",this.onContextMenu),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp)}removeEventListeners(){this._canvas.removeEventListener("mousedown",this.onMouseDown),this._canvas.removeEventListener("wheel",this.onMouseWheel),window.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp)}mousePosToCellPos(t){let e=t[0],i=t[1],s=null,n=null,r=this._endX,a=this._startX,u=this._startXInPx;0<this.frozenColumnCount&&e<=this._frozenColumnsWidthInPx&&(a=0,r=this.frozenColumnCount,u=0);for(let o=a;o<=r;++o){let d=u,m=d+this.columnsWidths[o];if(u=m,d<=e&&e<=m){s=o;break}}return n=this._startY+Math.floor((i-this._startYInPx)/this._rowSize),n>=this.data.length&&(n=null),[s,n]}get viewBox(){let t=l.sumOfArray(this.columnsWidths.slice(0,this.frozenColumnCount));return{startX:this.viewBoxOffset[0],startY:this.viewBoxOffset[1],endX:this.viewBoxOffset[0]+this._canvas.width-t,endY:this.viewBoxOffset[1]+this._canvas.height}}getStartXEndXForVisibleMovableColumns(){let t=0,e=this.viewBox,i=this.frozenColumnCount,s=this.frozenColumnCount;for(let n=this.frozenColumnCount;n<this.columnsWidths.length;++n)if(t+=this.columnsWidths[n],t>=e.startX){i=n,s=n;break}for(let n=i+1;n<this.columnsWidths.length&&(t+=this.columnsWidths[n],s=n,!(t>=e.endX));++n);return{startX:i,endX:s}}getStartYEndYForVisibleRows(){let t=this.viewBox;return{startY:Math.floor(t.startY/this._rowSize),endY:Math.floor(t.endY/this._rowSize)}}getBBoxOfMovableVisibleCells(){let{startX:t,endX:e}=this.getStartXEndXForVisibleMovableColumns(),{startY:i,endY:s}=this.getStartYEndYForVisibleRows();return{startX:t,startY:i,endX:e,endY:s}}isCellSelected(t,e){for(let i=0;i<this.selection.length-1;i+=2)if(this.selection[i]===t&&this.selection[i+1]===e)return!0;return!1}isCellActive(t,e){return this.activeCell.length===2&&this.activeCell[0]===t&&this.activeCell[1]===e}createDrawRectFunction(t,e,i,s,n,r,a){return()=>{a&&this._ctx.beginPath(),this._ctx.lineWidth=r,this._ctx.strokeStyle=n,this._ctx.rect(t,e,i,s),a&&this._ctx.stroke()}}drawCells(t,e,i,s){let n=this._ctx;n.beginPath(),n.strokeStyle="#000000",n.lineWidth=2;let r=this._rowSize,a=this._padding,u=e,o=i,d=w.emptyFunction,m=[];for(let h=0;h<t.length;++h){let O=t[h];for(let b=0;b<O.length;++b){let S=O[b],C=this.columnsWidths[s+b];n.fillText(S,u+a,o+r-a),n.rect(u,o,C,r),this.selection.find(F=>F)&&this.isCellSelected(s+b,this._startY+h)&&m.push(this.createDrawRectFunction(u,o,C,r,"#0000FF",3,!1)),this.isCellActive(s+b,this._startY+h)&&(d=this.createDrawRectFunction(u,o,C,r,"#00FF00",3,!0)),u+=C}u=e,o+=r}n.stroke(),n.beginPath();for(let h of m)h();n.stroke(),d()}destroy(){for(let t in this.signals)this.signals[t].removeAll();cancelAnimationFrame(this._requestAnimationFrameId),this.removeEventListeners()}};var g=class{static sleep(t){return new Promise((e,i)=>{setTimeout(e,t)})}};var y=class{constructor(){this._gridCanvas=new x(document.getElementById("gridCanvas"));this.onCellMouseDown=t=>{this._gridCanvas.activeCell=t};this.onKeyDown=t=>{let{activeCell:e}=this._gridCanvas;if(e.length===2)switch(t.key){case"Escape":e.length=0;break;case"ArrowLeft":e[0]>0&&e[0]--;break;case"ArrowRight":e[0]<this._gridCanvas.data[0].length-1&&e[0]++;break;case"ArrowUp":e[1]>0&&e[1]--;break;case"ArrowDown":e[1]<this._gridCanvas.data.length-1&&e[1]++;break}};this._gridCanvas.frozenColumnCount=2,this._gridCanvas.data=this.createDummyData(),this._gridCanvas.columnsWidths=this._gridCanvas.data[0].map(t=>l.randomFromInterval(80,120)),this._gridCanvas.signals.mouseDown.add(this.onCellMouseDown),this.initDemo(),this.addEventListeners()}createDummyData(){let t=20,e=50,i=[];for(let s=0;s<e;++s){let n=[];for(let r=0;r<t;++r)n.push(`${s*t+r}`);i.push(n)}return i}addEventListeners(){window.addEventListener("keydown",this.onKeyDown)}removeEventListeners(){window.removeEventListener("keydown",this.onKeyDown)}async initDemo(){await g.sleep(1e3),this._gridCanvas.activeCell=[4,9],await g.sleep(500),this._gridCanvas.selection=[6,2,3,5,4,5,5,5,3,6,4,6,5,6,0,8],await g.sleep(2500),this._gridCanvas.activeCell=[],await g.sleep(500),this._gridCanvas.selection=[]}},q=new y;})();
